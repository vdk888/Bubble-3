<!-- Dashboard Scripts Component -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chat elements
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const clearButton = document.getElementById('clear-button');

    // Portfolio elements
    const accountSummary = document.getElementById('account-summary');
    const toolContents = document.getElementById('tool-contents');
    const toolButtons = document.querySelectorAll('.tool-button');
    const actionButtons = document.querySelectorAll('.action-btn');

    // Tool content elements
    const positionsContent = document.getElementById('positions-content');
    const ordersContent = document.getElementById('orders-content');
    const tradeContent = document.getElementById('trade-content');
    const analysisContent = document.getElementById('analysis-content');

    // Function to mask sensitive data
    function maskSensitiveData(text) {
        text = text.replace(/ALPACA_API_KEY='[^']+'/g, "ALPACA_API_KEY='********'");
        text = text.replace(/ALPACA_SECRET_KEY='[^']+'/g, "ALPACA_SECRET_KEY='********'");
        return text;
    }

    // Function to store Alpaca credentials
    async function storeAlpacaCredentials(apiKey, secretKey) {
        try {
            const response = await fetch('/api/store_alpaca_credentials', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    alpaca_api_key: apiKey,
                    alpaca_secret_key: secretKey
                })
            });
            
            const data = await response.json();
            
            if (data.message) {
                addBotMessage(`✅ I've detected and securely stored your Alpaca API credentials. I'll help you with:
                • Real-time portfolio tracking
                • Trade monitoring
                • Market analysis
                • Stock information
                
                What would you like to know about?`);
                
                // Refresh portfolio data after storing credentials
                updatePortfolioData();
            }
        } catch (error) {
            console.error('Error:', error);
            addBotMessage(`❌ Sorry, there was an error storing your credentials. Please try again later.`);
        }
    }

    // Function to add a user message
    function addUserMessage(text) {
        const message = document.createElement('div');
        message.className = 'message user-message';
        message.innerHTML = maskSensitiveData(text);
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Function to add a bot message
    function addBotMessage(text) {
        const message = document.createElement('div');
        message.className = 'message bot-message';
        // Convert bullet points and preserve newlines
        text = text.replace(/•/g, '•').replace(/\n/g, '<br>');
        message.innerHTML = text;
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Function to process the message
    async function processMessage(message) {
        addUserMessage(message);

        // Check for Alpaca API credentials
        const apiKeyMatch = message.match(/ALPACA_API_KEY='([^']+)'/);
        const secretKeyMatch = message.match(/ALPACA_SECRET_KEY='([^']+)'/);
        
        if (apiKeyMatch && secretKeyMatch) {
            await storeAlpacaCredentials(apiKeyMatch[1], secretKeyMatch[1]);
            return;
        }

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();
            
            if (data.error) {
                addBotMessage('❌ Error: ' + data.error);
            } else {
                addBotMessage(data.response);
                
                // Handle any actions returned from the bot
                if (data.action) {
                    handleBotAction(data.action);
                }
            }
        } catch (error) {
            addBotMessage('❌ Error: Could not send message');
        }
    }

    // Function to handle bot actions
    function handleBotAction(action) {
        switch (action.type) {
            case 'show_positions':
                showTool('positions');
                break;
            case 'show_orders':
                showTool('orders');
                break;
            case 'show_trade':
                showTool('trade');
                break;
            case 'show_analysis':
                showTool('analysis');
                break;
            case 'place_order':
                handleOrderPlacement(action.data);
                break;
            case 'analyze_symbol':
                handleSymbolAnalysis(action.data);
                break;
        }
    }

    // Function to show a specific tool
    function showTool(toolName) {
        // Hide all tool contents first
        const allContents = document.querySelectorAll('.tool-content');
        allContents.forEach(content => content.style.display = 'none');

        // Show the tool contents container
        toolContents.style.display = 'block';

        // Show the specific tool content
        const content = document.getElementById(`${toolName}-content`);
        if (content) {
            content.style.display = 'block';
        }

        // Update active state of tool buttons
        toolButtons.forEach(button => {
            if (button.dataset.tool === toolName) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });

        // Load data for the tool
        switch (toolName) {
            case 'positions':
                loadPositions();
                break;
            case 'orders':
                loadOrders();
                break;
            case 'trade':
                initializeTradeForm();
                break;
            case 'analysis':
                initializeAnalysisForm();
                break;
        }
    }

    // Function to format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(value);
    }

    // Function to format percentage
    function formatPercentage(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'percent',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value / 100);
    }

    // Function to update portfolio data
    async function updatePortfolioData() {
        try {
            const response = await fetch('/api/portfolio/metrics');
            const data = await response.json();
            
            if (data.error) {
                accountSummary.innerHTML = `<div class="error-message">${data.error}</div>`;
                return;
            }

            // Update account summary
            let summaryHtml = '<div class="metrics-grid">';
            for (const [key, value] of Object.entries(data.metrics)) {
                summaryHtml += `
                    <div class="metric-card">
                        <div class="metric-title">${key}</div>
                        <div class="metric-value">${value}</div>
                    </div>`;
            }
            summaryHtml += '</div>';
            accountSummary.innerHTML = summaryHtml;
            accountSummary.classList.remove('loading');
        } catch (error) {
            console.error('Error updating portfolio:', error);
            accountSummary.innerHTML = '<div class="error-message">Error loading portfolio data. Please check your Alpaca credentials.</div>';
        }
    }

    // Function to load positions
    async function loadPositions() {
        const positionsData = document.getElementById('positions-data');
        try {
            const response = await fetch('/api/portfolio/positions');
            const data = await response.json();
            
            if (data.error) {
                positionsData.innerHTML = `<div class="error-message">${data.error}</div>`;
                return;
            }

            let html = '<div class="positions-list">';
            data.positions.forEach(position => {
                const plClass = position.unrealized_pl >= 0 ? 'positive' : 'negative';
                html += `
                    <div class="position-item">
                        <div class="position-header">
                            <span class="position-symbol">${position.symbol}</span>
                            <span class="position-qty">${position.qty} shares</span>
                        </div>
                        <div class="position-details">
                            <div class="detail">
                                <span class="label">Market Value:</span>
                                <span class="value">${formatCurrency(position.market_value)}</span>
                            </div>
                            <div class="detail">
                                <span class="label">P/L:</span>
                                <span class="value ${plClass}">${formatCurrency(position.unrealized_pl)} (${formatPercentage(position.unrealized_plpc)})</span>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
            positionsData.innerHTML = html;
        } catch (error) {
            positionsData.innerHTML = '<div class="error-message">Failed to load positions</div>';
        }
    }

    // Function to load orders
    async function loadOrders() {
        const ordersData = document.getElementById('orders-data');
        try {
            const response = await fetch('/api/portfolio/orders');
            const data = await response.json();
            
            if (data.error) {
                ordersData.innerHTML = `<div class="error-message">${data.error}</div>`;
                return;
            }

            let html = '<div class="orders-list">';
            data.orders.forEach(order => {
                html += `
                    <div class="order-item">
                        <div class="order-header">
                            <span class="order-symbol">${order.symbol}</span>
                            <span class="order-status ${order.status.toLowerCase()}">${order.status}</span>
                        </div>
                        <div class="order-details">
                            <div class="detail">
                                <span class="label">Type:</span>
                                <span class="value">${order.type} ${order.side}</span>
                            </div>
                            <div class="detail">
                                <span class="label">Quantity:</span>
                                <span class="value">${order.qty} shares</span>
                            </div>
                            <div class="detail">
                                <span class="label">Time:</span>
                                <span class="value">${new Date(order.submitted_at).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
            ordersData.innerHTML = html;
        } catch (error) {
            ordersData.innerHTML = '<div class="error-message">Failed to load orders</div>';
        }
    }

    // Event listeners for tool buttons
    toolButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tool = this.dataset.tool;
            showTool(tool);
        });
    });

    // Event listeners for chat actions
    actionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            messageInput.value = action;
            processMessage(action);
        });
    });

    // Event listeners for chat
    sendButton.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (message) {
            processMessage(message);
            messageInput.value = '';
        }
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const message = messageInput.value.trim();
            if (message) {
                processMessage(message);
                messageInput.value = '';
            }
        }
    });

    clearButton.addEventListener('click', () => {
        chatMessages.innerHTML = '';
        // Add initial welcome message
        addBotMessage(`👋 Hello! I'm your AI financial assistant. I can help you with:
            • Checking your portfolio value and positions
            • Placing and monitoring trades
            • Analyzing market trends
            • Getting technical analysis
            
            What would you like to know about?`);
    });

    // Initialize with welcome message
    addBotMessage(`👋 Hello! I'm your AI financial assistant. I can help you with:
        • Checking your portfolio value and positions
        • Placing and monitoring trades
        • Analyzing market trends
        • Getting technical analysis
        
        What would you like to know about?`);

    // Update portfolio data every 30 seconds
    updatePortfolioData();
    setInterval(updatePortfolioData, 30000);
});
</script>
