{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block styles %}
<style>
:root {
    --dark-bg-primary: #1a1a1a;
    --dark-bg-secondary: #2d2d2d;
    --dark-bg-tertiary: #363636;
    --dark-text-primary: #ffffff;
    --dark-text-secondary: #b3b3b3;
    --dark-border: #404040;
    --accent-color: #007bff;
    --accent-color-hover: #0056b3;
    --error-color: #dc3545;
    --success-color: #28a745;
}

.dashboard-container {
    display: flex;
    height: calc(100vh - 56px);
    background: var(--dark-bg-primary);
    margin: 0;
    padding: 0;
}

.chat-panel {
    flex: 0 0 50%;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--dark-border);
    background: var(--dark-bg-secondary);
}

.portfolio-panel {
    flex: 0 0 50%;
    display: flex;
    flex-direction: column;
    background: var(--dark-bg-secondary);
}

.panel-header {
    padding: 1rem;
    background: var(--dark-bg-tertiary);
    border-bottom: 1px solid var(--dark-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h2 {
    margin: 0;
    color: var(--dark-text-primary);
    font-size: 1.25rem;
    font-weight: 600;
}

#chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    background: var(--dark-bg-secondary);
}

.message {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    max-width: 85%;
    word-wrap: break-word;
    line-height: 1.4;
}

.message.user-message {
    margin-left: auto;
    background-color: var(--accent-color);
    color: var(--dark-text-primary);
}

.message.bot-message {
    margin-right: auto;
    background-color: var(--dark-bg-tertiary);
    color: var(--dark-text-primary);
}

.chat-input {
    padding: 1rem;
    background: var(--dark-bg-tertiary);
    border-top: 1px solid var(--dark-border);
}

.input-group {
    display: flex;
    gap: 0.5rem;
}

#message-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid var(--dark-border);
    border-radius: 0.5rem;
    background: var(--dark-bg-primary);
    color: var(--dark-text-primary);
    font-size: 1rem;
}

#message-input:focus {
    outline: none;
    border-color: var(--accent-color);
}

#send-button {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    background: var(--accent-color);
    color: var(--dark-text-primary);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background-color 0.2s;
}

#send-button:hover {
    background: var(--accent-color-hover);
}

.portfolio-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: var(--dark-bg-secondary);
}

.portfolio-card {
    background: var(--dark-bg-tertiary);
    border: 1px solid var(--dark-border);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.portfolio-card h3 {
    margin: 0 0 1rem 0;
    color: var(--dark-text-primary);
    font-size: 1.1rem;
    font-weight: 600;
}

.portfolio-card .loading {
    color: var(--dark-text-secondary);
    font-style: italic;
}

.settings-button {
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid var(--dark-border);
    border-radius: 0.5rem;
    color: var(--dark-text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.settings-button:hover {
    background: var(--dark-bg-primary);
    border-color: var(--accent-color);
}

.settings-button i {
    font-size: 0.9rem;
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: var(--dark-bg-secondary);
}

::-webkit-scrollbar-thumb {
    background: var(--dark-border);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--dark-text-secondary);
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="chat-panel">
        <div class="panel-header">
            <h2>Chat with AI</h2>
            <a href="{{ url_for('settings') }}" class="settings-button">
                <i class="fas fa-cog"></i> Settings
            </a>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-input">
            <div class="input-group">
                <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off">
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>
    
    <div class="portfolio-panel">
        <div class="panel-header">
            <h2>Portfolio Overview</h2>
        </div>
        <div class="portfolio-content">
            <div class="portfolio-card">
                <h3>Account Summary</h3>
                <div id="account-summary" class="loading">Waiting for API credentials...</div>
            </div>
            <div class="portfolio-card">
                <h3>Portfolio Performance</h3>
                <div id="portfolio-performance" class="loading">Waiting for API credentials...</div>
            </div>
            <div class="portfolio-card">
                <h3>Recent Trades</h3>
                <div id="recent-trades" class="loading">Waiting for API credentials...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const accountSummary = document.getElementById('account-summary');
    const portfolioPerformance = document.getElementById('portfolio-performance');
    const recentTrades = document.getElementById('recent-trades');

    // Function to mask sensitive data
    function maskSensitiveData(text) {
        // Mask Alpaca API keys
        text = text.replace(/ALPACA_API_KEY='[^']+'/g, "ALPACA_API_KEY='********'");
        text = text.replace(/ALPACA_SECRET_KEY='[^']+'/g, "ALPACA_SECRET_KEY='********'");
        return text;
    }

    // Function to store Alpaca credentials
    async function storeAlpacaCredentials(apiKey, secretKey) {
        try {
            const response = await fetch('/store_alpaca_credentials', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    alpaca_api_key: apiKey,
                    alpaca_secret_key: secretKey
                })
            });
            
            const data = await response.json();
            
            if (data.message) {
                // Add confirmation message to chat
                addBotMessage(`✅ I've detected and securely stored your Alpaca API credentials. I'll help you with real-time portfolio tracking, trade monitoring, market analysis, and stock information. What would you like to know about?`);
            }
        } catch (error) {
            console.error('Error:', error);
            addBotMessage(`❌ Sorry, there was an error storing your credentials. Please try again later.`);
        }
    }

    // Function to add a user message
    function addUserMessage(text) {
        const message = document.createElement('div');
        message.className = 'message user-message';
        message.innerHTML = maskSensitiveData(text);
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Function to add a bot message
    function addBotMessage(text) {
        const message = document.createElement('div');
        message.className = 'message bot-message';
        message.innerHTML = text;
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Function to process the message
    async function processMessage(message) {
        // Add user message to chat
        addUserMessage(message);

        // Check for API keys before sending to server
        const apiKeyMatch = message.match(/ALPACA_API_KEY='([^']+)'/);
        const secretKeyMatch = message.match(/ALPACA_SECRET_KEY='([^']+)'/);
        
        if (apiKeyMatch && secretKeyMatch) {
            await storeAlpacaCredentials(apiKeyMatch[1], secretKeyMatch[1]);
        }

        // Send message to server
        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();
            
            if (data.error) {
                addBotMessage('Error: ' + data.error);
            } else {
                addBotMessage(data.response);
                
                // Handle visual data if present
                if (data.visual_data) {
                    const visualContent = document.getElementById('visual-content');
                    // Add visual data handling here
                }
            }
        } catch (error) {
            addBotMessage('Error: Could not send message');
        }
    }

    // Function to format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(value);
    }

    // Function to format percentage
    function formatPercentage(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'percent',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value / 100);
    }

    // Function to update portfolio data
    async function updatePortfolioData() {
        try {
            // Get account summary
            const summaryResponse = await fetch('/api/portfolio/metrics');
            const summaryData = await summaryResponse.json();
            
            if (summaryData.error) {
                accountSummary.innerHTML = `<div class="error-message">${summaryData.error}</div>`;
                return;
            }

            // Update account summary
            let summaryHtml = '<div class="metrics-grid">';
            for (const [key, value] of Object.entries(summaryData.metrics)) {
                summaryHtml += `
                    <div class="metric-item">
                        <div class="metric-label">${key}</div>
                        <div class="metric-value">${value}</div>
                    </div>`;
            }
            summaryHtml += '</div>';
            accountSummary.innerHTML = summaryHtml;
            accountSummary.classList.remove('loading');

            // Get portfolio performance
            const performanceResponse = await fetch('/api/portfolio/performance');
            const performanceData = await performanceResponse.json();
            
            if (performanceData.error) {
                portfolioPerformance.innerHTML = `<div class="error-message">${performanceData.error}</div>`;
                return;
            }

            // Update portfolio performance
            let performanceHtml = `
                <div class="performance-stats">
                    <div class="stat">
                        <span class="label">Today's Return:</span>
                        <span class="value ${performanceData.today_return >= 0 ? 'positive' : 'negative'}">
                            ${formatPercentage(performanceData.today_return)}
                        </span>
                    </div>
                    <div class="stat">
                        <span class="label">Total Return:</span>
                        <span class="value ${performanceData.total_return >= 0 ? 'positive' : 'negative'}">
                            ${formatPercentage(performanceData.total_return)}
                        </span>
                    </div>
                </div>`;
            portfolioPerformance.innerHTML = performanceHtml;
            portfolioPerformance.classList.remove('loading');

            // Get recent trades
            const tradesResponse = await fetch('/api/portfolio/trades');
            const tradesData = await tradesResponse.json();
            
            if (tradesData.error) {
                recentTrades.innerHTML = `<div class="error-message">${tradesData.error}</div>`;
                return;
            }

            // Update recent trades
            if (tradesData.trades.length === 0) {
                recentTrades.innerHTML = '<div class="no-trades">No recent trades</div>';
            } else {
                let tradesHtml = '<div class="trades-list">';
                for (const trade of tradesData.trades) {
                    tradesHtml += `
                        <div class="trade-item">
                            <div class="trade-symbol">${trade.symbol}</div>
                            <div class="trade-details">
                                <span class="trade-side ${trade.side}">${trade.side}</span>
                                <span class="trade-quantity">${trade.qty} shares</span>
                                <span class="trade-price">@ ${formatCurrency(trade.price)}</span>
                            </div>
                            <div class="trade-time">${new Date(trade.timestamp).toLocaleString()}</div>
                        </div>`;
                }
                tradesHtml += '</div>';
                recentTrades.innerHTML = tradesHtml;
            }
            recentTrades.classList.remove('loading');

        } catch (error) {
            console.error('Error updating portfolio:', error);
            accountSummary.innerHTML = '<div class="error-message">Error loading portfolio data</div>';
            portfolioPerformance.innerHTML = '<div class="error-message">Error loading performance data</div>';
            recentTrades.innerHTML = '<div class="error-message">Error loading trades data</div>';
        }
    }

    // Add additional styles for portfolio content
    const style = document.createElement('style');
    style.textContent = `
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .metric-item {
            padding: 1rem;
            background: var(--dark-bg-tertiary);
            border-radius: 0.5rem;
            border: 1px solid var(--dark-border);
        }

        .metric-label {
            color: var(--dark-text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            color: var(--dark-text-primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .performance-stats {
            display: grid;
            gap: 1rem;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--dark-bg-tertiary);
            border-radius: 0.5rem;
            border: 1px solid var(--dark-border);
        }

        .stat .label {
            color: var(--dark-text-secondary);
        }

        .stat .value {
            font-weight: 600;
        }

        .value.positive {
            color: var(--success-color);
        }

        .value.negative {
            color: var(--error-color);
        }

        .trades-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .trade-item {
            padding: 0.75rem;
            background: var(--dark-bg-tertiary);
            border-radius: 0.5rem;
            border: 1px solid var(--dark-border);
        }

        .trade-symbol {
            font-weight: 600;
            color: var(--dark-text-primary);
            margin-bottom: 0.25rem;
        }

        .trade-details {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .trade-side {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .trade-side.buy {
            background: var(--success-color);
            color: var(--dark-text-primary);
        }

        .trade-side.sell {
            background: var(--error-color);
            color: var(--dark-text-primary);
        }

        .trade-time {
            color: var(--dark-text-secondary);
            font-size: 0.875rem;
        }

        .error-message {
            color: var(--error-color);
            font-style: italic;
        }

        .no-trades {
            color: var(--dark-text-secondary);
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
    `;
    document.head.appendChild(style);

    // Update portfolio data every 30 seconds
    updatePortfolioData();
    setInterval(updatePortfolioData, 30000);

    // Event listener for send button
    sendButton.addEventListener('click', async function() {
        const message = messageInput.value.trim();
        if (message) {
            messageInput.value = '';
            await processMessage(message);
        }
    });

    // Event listener for Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendButton.click();
        }
    });

    // Load initial message if user has no API keys
    fetch('/chat', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.initial_message) {
            addBotMessage(data.initial_message);
        }
    })
    .catch(error => {
        console.error('Error loading initial message:', error);
    });
});
</script>
{% endblock %}
